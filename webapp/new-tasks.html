<!DOCTYPE HTML>
<html>
<head>
<title>Business Control</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<script type="application/x-javascript"> addEventListener("load", function() { setTimeout(hideURLbar, 0); }, false); function hideURLbar(){ window.scrollTo(0,1); } </script>
 <!-- Bootstrap Core CSS -->
<link href="css/bootstrap.min.css" rel='stylesheet' type='text/css' />
<!-- Custom CSS -->
<link href="css/style.css" rel='stylesheet' type='text/css' />
<link href="css/font-awesome.css" rel="stylesheet"> 
<!-- jQuery -->
<script src="js/jquery.min.js"></script>
<!----webfonts--->
<link href='//fonts.googleapis.com/css?family=Roboto:400,100,300,500,700,900' rel='stylesheet' type='text/css'>    
<!-- Nav CSS -->
<link href="css/custom.css" rel="stylesheet">
<!-- Metis Menu Plugin JavaScript -->
<script src="js/metisMenu.min.js"></script>
<script src="js/custom.js"></script>
<!--Calendar-->
<script type="text/javascript" src="js/bootstrap-datepicker.js" ></script>
<script type="text/javascript" src="js/bootstrap-datepicker.ru.js" charset="UTF-8"></script>
<link href="css/datepicker.css" rel="stylesheet">
<!--Editor-->
 <script src="//cdn.tinymce.com/4/tinymce.min.js"></script>
  <script>tinymce.init({ selector:'#editor' });</script>

</head>
<body>
<div id="wrapper">
     <!-- Navigation -->
        <nav class="top1 navbar navbar-default navbar-static-top" role="navigation" style="margin-bottom: 0">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#">Новые Задания</a>
            </div>
            <!-- /.navbar-header -->            
			
            <div class="navbar-default sidebar" role="navigation">
                <div class="sidebar-nav navbar-collapse">
				<img src="img/logo.png" /> 
                    <ul class="nav" id="side-menu">
                        <li>
                            <a href="index.html"><i class="fa fa-dashboard fa-fw nav_icon"></i>Dashboard</a>
                        </li>
                        <li>
                            <a href="#"><i class="fa fa-users"></i> Сотрудники<span class="fa arrow"></span></a>
                            <ul class="nav nav-second-level">
                                <li>
                                    <a href="groups-list.html">Группы</a>
                                </li>
								<li>
                                    <a href="users-list.html">Общий список</a>
                                </li>
                            </ul>
                            <!-- /.nav-second-level -->
                        </li>
                        <li>
                            <a href="#"><i class="fa fa-truck"></i> Маршрут<span class="fa arrow"></span></a>
                            <ul class="nav nav-second-level">
                                <li>
                                    <a href="route.html">Выбрать маршрут</a>
                                </li>
                                <li>
                                    <a href="#">Маршруты  <span class="fa arrow"></span></a>
									<ul class="nav nav-second-level">
                                <li>
                                    <a href="new-routes.html">Новые</a>
                                </li>
                                <li>
                                    <a href="old-routes.html">Архив</a>
                                </li>
                            </ul>
                                </li>
                            </ul>
                            <!-- /.nav-second-level -->
                        </li>
                        <li>
                            <a href="#"><i class="fa fa-file"></i> Задание<span class="fa arrow"></span></a>
                            <ul class="nav nav-second-level">
                                <li>
                                    <a href="task.html">Создать задание</a>
                                </li>
                                <li>
                                    <a href="#">Задания <span class="fa arrow"></span></a>
									<ul class="nav nav-second-level">
                                <li>
                                    <a href="new-tasks.html">Новые</a>
                                </li>
                                <li>
                                    <a href="old-tasks.html">Архив</a>
                                </li>
                            </ul>
                                </li>
                            </ul>
                            <!-- /.nav-second-level -->
                        </li>
                        <li>
                            <a href="#"><i class="fa fa-file-text"></i> Текст задания <span class="fa arrow"></span></a>
							<ul class="nav nav-second-level">
                                <li>
                                    <a href="desc.html">Создать описание</a>
                                </li>
                                <li>
                                    <a href="#">Описания <span class="fa arrow"></span></a>
									<ul class="nav nav-second-level">
                                <li>
                                    <a href="new-descs.html">Новые</a>
                                </li>
                                <li>
                                    <a href="old-descs.html">Архив</a>
                                </li>
                            </ul>
                                </li>
                            </ul>
                            <!-- /.nav-second-level -->
                        </li>
                         <li>
                            <a href="#"><i class="fa fa-android"></i> Мобильные приложения</a>
                            
                        </li>                        
                        
                    </ul>
                </div>
                <!-- /.sidebar-collapse -->
            </div>
            <!-- /.navbar-static-side -->
        </nav>
        <div id="page-wrapper">
		<div class="graphs">
       <div class = "col_3">  
	   

        	<div class="clearfix"> </div>
      </div> 
	  
	  
	  <div class="col_1">
<div class="col-md-6">	
<div class="refresh" style="cursor: pointer; margin-left:22%"><i class="fa fa-refresh" ></i></div>
	<div class="datepicker"></div>
	
<script type="text/javascript">  
  var dp = $('.datepicker').datepicker({
   language: "ru-RU"
});
 $( ".refresh" ).click(function() {
  dp.datepicker('update');
});
dp.on('changeDate', function(ev){
       
    });
</script>

		    </div>
			<div class="clearfix"> </div>
			</div>
      
			
		    <div class="span_11">
		<div class="col-md-12">
		<div id="map" style="height:500px;"></div>
    
    <script>
var map;
function initMap() {
  map = new google.maps.Map(document.getElementById('map'), {
    zoom: 15
  });
  var infoWindow = new google.maps.InfoWindow({map: map});

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
      var pos = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      };
      infoWindow.setPosition(pos);     
      map.setCenter(pos);
    }, function() {
      handleLocationError(true, infoWindow, map.getCenter());
    });
  } else {
    // Browser doesn't support Geolocation
    handleLocationError(false, infoWindow, map.getCenter());
  }  
  
}

function handleLocationError(browserHasGeolocation, infoWindow, pos) {
  infoWindow.setPosition(pos);
  infoWindow.setContent(browserHasGeolocation ?
                        'Error: The Geolocation service failed.' :
                        'Error: Your browser doesn\'t support geolocation.');
}

	</script>
	
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCb9Iir38HyF_E3_hmf3mHHum_tJbgvjXs&callback=initMap"
    async defer></script>
	
	<script>
	  var url = 'http://buisness-control.appspot.com/tasks/?callback=?';
 
$.ajax({
   type: 'GET',
    url: url,
	data: {
	state:'new'
	},
    async: true,
    jsonpCallback: 'getNewTasks',
    contentType: "application/json",
    dataType: 'jsonp',
    success: function(json) {
       var items = [];
  $.each( json.tasks, function( key, val ) {  
  
  var track="";
  var trackRoute="";
  var trackAccount="";
  
  if (val.track===undefined){
  track="";
  trackRoute="";
  trackAccount="";
  }else{
  $.each( val.track, function( key, subval ) { 
  track=track+"\n"+subval.account+" Дата: "+subval.date+" Координаты: "+subval.lat+" "+subval.lng;
  if(trackRoute=="")trackRoute=subval.lat+","+subval.lng;
  trackRoute=trackRoute+","+subval.lat+","+subval.lng;
  if(trackAccount=="")trackAccount=subval.account;  
  trackAccount=trackAccount+","+subval.account;  
  });
  }
  
var subitems=[];
  if (val.reports!==undefined){  
  $.each( val.reports, function( key, subval ) { 
  var reportAccount=subval.account;
  var reportText=subval.report;
  var reportPhotos=subval.photos;
  
  var subsubitems=[];
  if (reportPhotos!==undefined){  
  $.each( reportPhotos, function( key, subsubval ) { 
  var url=subsubval.servingUrl;
  var key=subsubval.blobKey;
  subsubitems.push("<br/><image class='img-responsive' src="+url+" alt=''><br/>");
  });  
  }
  
 subitems.push("<div class='row'><div class='col-sm-12'><br/><p class='label label-success'>Отчет:</p><p>"+reportAccount+"</p><p><textarea class='form-control'>"+reportText+"</textarea></p><p>"+subsubitems.join( "" )+"</p></div></div>");
  
  });
  }  
  
  items.push( "<br/><a href='#' class='list-group-item' data-toggle='collapse' data-target='#" + val.name.replace(/[\.,\:,\/, ,\(,\),=,?,-,@]/g,"") + "' >" + val.name + "</a><div id='" + val.name.replace(/[\.,\:,\/, ,\(,\),=,?,-,@]/g,"") + "' class='collapse'> <div class='col-sm-12'>"+val.date+"</div><div class='col-sm-12'><br/><p class='label label-success'>Описание:</p><textarea class='form-control'>"+JSON.stringify(val.descs).replace(/[\"\[\]]/g,"")+"</textarea></div><div class='col-sm-12'><br/><p class='label label-success'>Сотрудники:</p><textarea class='form-control'>"+JSON.stringify(val.users).replace(/[\"\[\]]/g,"")+"</textarea></div><div class='col-sm-12'><br/><p class='label label-success'>Маршрут:</p><textarea class='form-control'>"+JSON.stringify(val.routes).replace(/[\"\[\]\{\}]/g,"")+"</textarea></div><div class='row'><div class='col-sm-4'><button type='button' class='btn btn-primary btn-map' data-title='"+val.date+"' data-route='"+JSON.stringify(val.routes).replace(/[\"\[\]\{\}]/g,"")+"' >Показать на карте</button></div></div><br/><div class='col-sm-12'><br/><p class='label label-success'>Отслеживание:</p><textarea class='form-control'>"+track+"</textarea></div><br/><div class='row'><div class='col-sm-4'><button type='button' class='btn btn-primary btn-mapTrack' data-title='"+trackAccount+"' data-route='"+trackRoute+"' >Показать на карте</button></div></div><br/>"+subitems.join( "" )+"<br/><div class='row'><div class='col-sm-4'><button type='button' class='btn btn-primary btn-state' data-name='"+val.name+"' >Отправить в архив</button></div><div class='col-sm-4'><button type='button' class='btn btn-danger btn-del-task' data-name='"+val.name+"' >Удалить задачу</button></div></div></div>");  
  
  });

  $( "<div/>", {
    "class": "list-group",
    html: items.join( "" )
  }).appendTo( ".col_3" );  
  
   $( ".btn-map" ).click(function() {
  var route = $(this).attr('data-route').split(","); 
  var title = $(this).attr('data-title');
  for (var i = 0; i < route.length; i++) {
  
 var latLng =new google.maps.LatLng(route[i+1].replace("lat:",""), route[i].replace("lng:",""));  
 var marker = new google.maps.Marker({
    position: latLng,
	title: title,
    map: map
  });  
  map.setCenter(latLng);
  i=i+1;
}

});
  
  
   $( ".btn-mapTrack" ).click(function() {   
  var route = $(this).attr('data-route').split(","); 
  
  var title = $(this).attr('data-title').split(",");
  var j=0;
  for (var i = 0; i < route.length; i++) {
  
 var latLng =new google.maps.LatLng(route[i], route[i+1]);  
 var marker = new google.maps.Marker({
    position: latLng,
	title: title[j],
    map: map
  });  
  map.setCenter(latLng);
  i=i+1;
  j=j+1;
}

});
  

$( ".btn-state" ).click(function() { 
var name = $(this).attr('data-name');

var url = 'http://buisness-control.appspot.com/puttaskstate/?callback=?';
 
$.ajax({
   type: 'GET',
    url: url,
	data: {
	state:'old',
	name:name
	},
    async: false,
    jsonpCallback: 'putTaskState',
    contentType: 'application/json',
    dataType: 'jsonp',
    success: function(json) { 
  location.reload();
    }
});

 }); 
 
 $( ".btn-del-task" ).click(function() { 
var name = $(this).attr('data-name');

var url = 'http://buisness-control.appspot.com/deletetask/?callback=?';
 
$.ajax({
   type: 'GET',
    url: url,
	data: {
	name:name
	},
    async: false,
    jsonpCallback: 'deleteTask',
    contentType: 'application/json',
    dataType: 'jsonp',
    success: function(json) { 
  location.reload();
    }
});

 }); 
    }
});
	  </script>

		  
		</div>   
       <div class="clearfix"> </div>
    </div>
    
		<div class="copy">
            <p>Copyright &copy; 2015 TM SoftStudio</p>
	    </div>
		</div>
       </div>
      <!-- /#page-wrapper -->
   </div>
    <!-- /#wrapper -->
    <!-- Bootstrap Core JavaScript -->
    <script src="js/bootstrap.min.js"></script>
</body>
</html>
